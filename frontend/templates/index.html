<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Analyst Agent</title>
    
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script type="text/javascript" src="https://golden-layout.com/files/latest/js/goldenlayout.min.js"></script>
    <link type="text/css" rel="stylesheet" href="https://golden-layout.com/files/latest/css/goldenlayout-base.css" />
    
    <link id="hljs-theme" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.32.6/ace.js"></script>

    <!-- xterm.js â€” integrated terminal -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@xterm/addon-fit@0.10.0/lib/addon-fit.js"></script>

    <link rel="stylesheet" href="/static/style.css">
    <style>
        .conditional-options { display: none; padding-left: 10px; border-left: 2px solid var(--border); margin-top: 10px; }
        .indented-option { margin-bottom: 10px; }
    </style>
</head>
<body data-theme="dark">

<div class="theme-toggle" onclick="toggleTheme()">
    <i class="fas fa-moon" id="theme-icon"></i>
</div>

<div id="layoutContainer"></div>

<div class="modal fade" id="sessionDialog" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="sessionDialogTitle">New Session</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="sessionForm">
          <input type="hidden" name="session_id" id="sessionIdInput">

          <!-- Tab Navigation -->
          <ul class="nav nav-tabs mb-3" id="sessionConfigTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="tab-session" data-bs-toggle="tab" data-bs-target="#pane-session" type="button" role="tab">Session</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-database" data-bs-toggle="tab" data-bs-target="#pane-database" type="button" role="tab">Database</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="tab-specialty" data-bs-toggle="tab" data-bs-target="#pane-specialty" type="button" role="tab">Specialty</button>
            </li>
          </ul>

          <!-- Tab Content -->
          <div class="tab-content" id="sessionConfigTabContent">

            <!-- SESSION TAB -->
            <div class="tab-pane fade show active" id="pane-session" role="tabpanel">
              <div class="mb-3">
                <label class="form-label">Name</label>
                <input type="text" class="form-control" name="name" id="sessionNameInput" value="Analysis #1" required>
              </div>

              <div class="mb-3">
                <label class="form-label">Language</label>
                <div class="d-flex align-items-center gap-3" id="languageSwitchGroup">
                  <div class="form-check form-check-inline m-0">
                    <input class="form-check-input" type="radio" name="language" id="langPython" value="python" checked>
                    <label class="form-check-label" for="langPython"><i class="fab fa-python me-1"></i>Python</label>
                  </div>
                  <div class="form-check form-check-inline m-0">
                    <input class="form-check-input" type="radio" name="language" id="langR" value="r">
                    <label class="form-check-label" for="langR"><i class="fab fa-r-project me-1"></i>R</label>
                  </div>
                  <small class="text-muted ms-auto" id="languageLockHint" style="display:none;"><i class="fas fa-lock me-1"></i>Cannot change after creation</small>
                </div>
              </div>

              <h6 class="text-muted border-bottom pb-2 mb-3 mt-4">Agent Configuration</h6>

              <div class="mb-3">
                  <label class="form-label small">Provider</label>
                  <select class="form-select form-select-sm" name="llm_provider" id="llmProviderSelect">
                      <option value="openai" selected>OpenAI</option>
                      <option value="azure">Azure OpenAI</option>
                      <option value="vllm">vLLM</option>
                      <option value="sglang">SGLang</option>
                      <option value="openrouter">OpenRouter</option>
                  </select>
              </div>

              <div id="openai-options" class="conditional-options">
                 <div class="row g-2">
                     <div class="col-6">
                        <label class="form-label small">Model</label>
                        <input type="text" class="form-control form-control-sm" name="llm_model" placeholder="gpt-4.1">
                     </div>
                     <div class="col-6">
                        <label class="form-label small">API Key</label>
                        <input type="password" class="form-control form-control-sm" name="llm_api_key" placeholder="sk-...">
                     </div>
                     <div class="col-12">
                        <label class="form-label small">Base URL (Optional)</label>
                        <input type="text" class="form-control form-control-sm" name="llm_base_url">
                     </div>
                 </div>
              </div>

              <div id="azure-options" class="conditional-options">
                 <div class="row g-2">
                     <div class="col-6">
                        <label class="form-label small">Model / Deployment</label>
                        <input type="text" class="form-control form-control-sm" name="llm_model_azure" placeholder="gpt-4">
                     </div>
                     <div class="col-6">
                        <label class="form-label small">API Version</label>
                        <input type="text" class="form-control form-control-sm" name="llm_api_version" placeholder="2023-12-01-preview">
                     </div>
                     <div class="col-12">
                        <label class="form-label small">Azure Endpoint (Base URL)</label>
                        <input type="text" class="form-control form-control-sm" name="llm_base_url_azure" placeholder="https://resource.openai.azure.com/">
                     </div>
                     <div class="col-12">
                        <label class="form-label small">API Key</label>
                        <input type="password" class="form-control form-control-sm" name="llm_api_key_azure">
                     </div>
                 </div>
              </div>

              <div id="generic-options" class="conditional-options">
                 <div class="row g-2">
                     <div class="col-6">
                        <label class="form-label small">Model Name</label>
                        <input type="text" class="form-control form-control-sm" name="llm_model_generic">
                     </div>
                     <div class="col-6">
                        <label class="form-label small">API Key</label>
                        <input type="password" class="form-control form-control-sm" name="llm_api_key_generic">
                     </div>
                     <div class="col-12">
                        <label class="form-label small">Base URL</label>
                        <input type="text" class="form-control form-control-sm" name="llm_base_url_generic" placeholder="http://localhost:8000/v1">
                     </div>
                 </div>
              </div>

              <div class="row g-2 mb-3">
                 <div class="col-4">
                    <label class="form-label small">Temperature</label>
                    <input type="number" step="0.1" min="0" max="2" class="form-control form-control-sm" name="temperature" id="temperatureInput" value="1.0">
                 </div>
                 <div class="col-4">
                    <label class="form-label small">Top P</label>
                    <input type="number" step="0.1" min="0" max="1" class="form-control form-control-sm" name="top_p" id="topPInput" value="1.0">
                 </div>
                 <div class="col-4">
                    <label class="form-label small">Reasoning Effort</label>
                    <select class="form-select form-select-sm" name="reasoning_effort" id="reasoningEffortSelect">
                        <option value="not_applicable" selected>Not Applicable</option>
                        <option value="low">Low</option>
                        <option value="medium">Medium</option>
                        <option value="high">High</option>
                    </select>
                 </div>
              </div>
            </div>

            <!-- DATABASE TAB -->
            <div class="tab-pane fade" id="pane-database" role="tabpanel">
              <div class="mb-2">
                <label class="form-label small" id="dbConnectionLabel">Connection Code</label>
                <div class="small text-muted mb-2" id="dbConnectionHint">
                   Write code that creates a database connection variable.
                </div>
                <textarea class="form-control form-control-sm font-monospace" name="db_connection_code" id="dbConnectionCodeInput" rows="8"></textarea>
                <button type="button" class="btn btn-sm btn-outline-info mt-2" id="testConnectionBtn">
                   <i class="fas fa-plug"></i> Test Connection
                </button>
                <span id="connectionTestResult" class="ms-2 small"></span>
              </div>
            </div>

            <!-- SPECIALTY TAB -->
            <div class="tab-pane fade" id="pane-specialty" role="tabpanel">
              <div class="mb-2">
                <label class="form-label small">Pre-defined Specialty</label>
                <select class="form-select form-select-sm mb-2" id="specialtySelect">
                  <option value="none" selected>None</option>
                  <option value="custom">Custom</option>
                  <!-- Pre-defined specialties populated dynamically -->
                </select>
              </div>
              <div class="mb-2">
                <label class="form-label small">Specialty Prompt</label>
                <div class="small text-muted mb-2">
                   Domain or task-specific instructions appended to the agent's system prompt. Select a pre-defined specialty above or write your own.
                </div>
                <div class="specialty-editor-container" id="specialtyEditorContainer">
                  <button type="button" class="specialty-expand-btn" id="specialtyExpandBtn" title="Expand editor">
                    <i class="fas fa-expand"></i>
                  </button>
                  <div id="specialtyAceEditor"></div>
                </div>
              </div>
            </div>

          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-sm btn-primary" id="saveSessionBtn" style="background: var(--accent); border:none;">Create</button>
      </div>
    </div>
  </div>
</div>

<template id="tpl-sidebar">
    <div class="panel-container">
        <button class="btn btn-primary w-100 mb-3" id="openCreateSessionBtn" style="background: var(--accent); border:none;">
            <i class="fas fa-plus"></i> New Session
        </button>
        <div id="session-list">
            </div>
    </div>
</template>

<template id="tpl-chat">
    <div class="panel-container">
        <div id="chat-history">
            <div class="text-center text-muted mt-5" style="opacity:0.5;">
                <i class="fas fa-robot fa-3x mb-3"></i><br>
                Select a session to start analysis.
            </div>
        </div>
        
        <div class="input-wrapper">
            <textarea id="user-input" rows="1" placeholder="Type instructions here... (Shift+Enter for new line)"></textarea>
            <button class="send-btn" id="send-btn"><i class="fas fa-paper-plane"></i></button>
        </div>
    </div>
</template>

<template id="tpl-env">
    <div class="panel-container">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="text-muted small text-uppercase m-0" id="env-header">Environment</h6>
            <div class="form-check form-switch m-0">
                <input class="form-check-input" type="checkbox" id="var-filter-check" checked>
                <label class="form-check-label small text-muted" for="var-filter-check" style="font-size: 0.75rem;">Hide Modules</label>
            </div>
        </div>
        <div id="python-vars">
            <div class="text-center text-muted small mt-5">No active state</div>
        </div>
    </div>
</template>

<template id="tpl-files">
    <div class="panel-container">
        <div class="d-flex justify-content-between mb-3 align-items-center">
            <h6 class="text-muted small text-uppercase m-0">Workspace</h6>
            <div>
                <button class="btn btn-sm btn-link text-secondary p-0 me-2" id="refresh-files" ><i class="fas fa-sync"></i></button>
                <button class="btn btn-sm btn-link text-primary p-0" id="upload-btn" ><i class="fas fa-upload"></i></button>
                <input type="file" id="file-input" class="d-none">
            </div>
        </div>
        <div id="file-tree">
            </div>
    </div>
</template>

<template id="tpl-editor">
    <div class="panel-container editor-panel">
        <div class="editor-header">
            <div class="editor-tabs" id="editor-tabs">
                </div>
            <div class="editor-actions">
                <button class="btn btn-sm btn-outline-primary me-1" id="editor-run-btn" title="Run script in terminal" disabled>
                    <i class="fas fa-play"></i> Run
                </button>
                <button class="btn btn-sm btn-outline-primary me-2" id="editor-run-line-btn" title="Run line / selection (Shift+Enter)" disabled>
                    <i class="fas fa-step-forward"></i> Run Line
                </button>
                <button class="btn btn-sm btn-outline-success me-1" id="editor-save-btn" title="Save (Ctrl+S)" disabled>
                    <i class="fas fa-save"></i> Save
                </button>
                <button class="btn btn-sm btn-outline-secondary" id="editor-download-btn" title="Download">
                    <i class="fas fa-download"></i>
                </button>
            </div>
        </div>
        <div class="editor-status-bar">
            <span id="editor-file-path" class="text-muted small"></span>
            <span id="editor-status" class="small"></span>
        </div>
        <div class="editor-content" id="editor-content">
            <div class="editor-placeholder">
                <i class="fas fa-file-code fa-3x mb-3"></i>
                <div>Click a file in the workspace to open it here</div>
                <div class="small text-muted mt-2">Supported: .py, .r, .sql, .csv, .json, .md, and more</div>
            </div>
        </div>
        <div class="editor-warning" id="editor-warning" style="display: none;">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <span id="editor-warning-text"></span>
        </div>
        <div class="editor-readonly-overlay" id="editor-readonly-overlay" style="display: none;">
            <div class="overlay-content">
                <i class="fas fa-lock fa-2x mb-2"></i>
                <div>Editor is locked while agent is running</div>
                <div class="small text-muted">Click Stop to cancel and edit</div>
            </div>
        </div>
    </div>
</template>

<!-- Terminal Panel Template -->
<template id="tpl-terminal">
    <div class="terminal-panel-container">
        <div class="terminal-tabs-bar" id="terminal-tabs-bar">
            <button class="terminal-scroll-btn" id="terminal-scroll-left" title="Scroll tabs left" style="display:none">
                <i class="fas fa-chevron-left"></i>
            </button>
            <div class="terminal-tabs-list" id="terminal-tabs-list"></div>
            <button class="terminal-scroll-btn" id="terminal-scroll-right" title="Scroll tabs right" style="display:none">
                <i class="fas fa-chevron-right"></i>
            </button>
            <button class="terminal-new-btn" id="terminal-new-btn" title="New Terminal">
                <i class="fas fa-plus"></i>
            </button>
        </div>
        <div class="terminal-body" id="terminal-body">
            <div class="terminal-placeholder" id="terminal-placeholder">
                <div class="text-center" style="padding-top: 48px; color: #888;">
                    <i class="fas fa-terminal fa-2x mb-3"></i>
                    <div>No terminals open</div>
                    <div class="small mt-1">Click <strong>+</strong> to open a terminal</div>
                </div>
            </div>
        </div>
    </div>
</template>

<!-- File Viewer Panel Template (images, datasets, binary files) -->
<template id="tpl-fileviewer">
    <div class="panel-container fileviewer-panel">
        <div class="fileviewer-header">
            <span id="fileviewer-file-path" class="text-muted small"></span>
            <button class="btn btn-sm btn-outline-secondary" id="fileviewer-download-btn" title="Download" style="display:none">
                <i class="fas fa-download"></i>
            </button>
        </div>
        <div class="fileviewer-content" id="fileviewer-content">
            <div class="editor-placeholder">
                <i class="fas fa-file-image fa-3x mb-3"></i>
                <div>Non-editable files open here</div>
                <div class="small text-muted mt-2">Images, datasets, and binary files</div>
            </div>
        </div>
    </div>
</template>

<!-- Specialty Prompt Expand Modal -->
<div class="modal fade" id="specialtyExpandModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Specialty Prompt</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body p-0">
        <div id="specialtyExpandAceEditor"></div>
        <div id="specialtyExpandPreview" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-sm btn-outline-secondary" id="specialtyPreviewToggle">
          <i class="fas fa-eye me-1"></i>Preview
        </button>
        <button type="button" class="btn btn-sm btn-primary" id="specialtyExpandApplyBtn" style="background: var(--accent); border:none;">Apply</button>
      </div>
    </div>
  </div>
</div>

<script src="/static/app.js"></script>

</body>
</html>